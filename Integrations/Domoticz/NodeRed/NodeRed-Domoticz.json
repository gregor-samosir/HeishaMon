[{"id":"6f1bd5f9.4cdd9c","type":"tab","label":"HeishaMon","disabled":true,"info":""},{"id":"1279ec70.ed6354","type":"mqtt in","z":"6f1bd5f9.4cdd9c","name":"MQTT HeishaSensor","topic":"panasonic_heat_pump/sdc/#","qos":"2","datatype":"auto","broker":"2298f8af.6176e8","x":200,"y":300,"wires":[["14572908.cd7c9f"]]},{"id":"14572908.cd7c9f","type":"function","z":"6f1bd5f9.4cdd9c","name":"Map sensor to ID","func":"// if there's an entry in the global defined variable then \n// the value needs to be saved (send) to next function \nvar sensorsplit = msg.topic.split(\"/\");\nvar sensor = sensorsplit[sensorsplit.length-1];\n \nvar sensorvalue = msg.payload;\nfor (i = 0; i < context.global.heishamon.SensorMapping.length; i++) {\n    // when sensor is in the global settings \n    msg.sensor = sensor;\n    if(sensor == context.global.heishamon.SensorMapping[i][0]){\n//        node.warn(context.global.heishamon.SensorMapping[i]);\n        // add the home automation ID/name \n        msg.HAid = context.global.heishamon.SensorMapping[i][1];\n\n        // add type (if it exists):\n        if(context.global.heishamon.SensorMapping[i][2]){\n            msg.type = context.global.heishamon.SensorMapping[i][2];\n        }    \n        return msg;\n    }\n}\nreturn;","outputs":1,"noerr":0,"x":470,"y":300,"wires":[["c33d4c1c.9461f8"]]},{"id":"5a304122.7f39e8","type":"function","z":"6f1bd5f9.4cdd9c","name":"global setup","func":"if (!context.global.heishamon) {\n  context.global.heishamon = {};\n}\n\n// write down the Home Automation applications used\n// Possible values: Domoticz, InfluxDB, openHAB, HomeAssistant\n// comma seperated and case sensitive\ncontext.global.heishamon.HAapplication = \"Domoticz, InfluxDB\";\n\n\n//This is the overview of sensors which has to be sent to the Home Automation system\ncontext.global.heishamon.SensorMapping = [\n        // [\"name of topic\", \"IDx in Domoticz/Name in Home Assistant/ ?? openHAB ??\"]\n            [\"Heatpump_State\", 1703, \"Switch\"],\n            [\"Pump_Flow\", 1609],\n            [\"Force_DHW_State\", null, \"Selector Switch\"], //DHW status (20=off, 10=on 0=unknown)\n            [\"Quiet_Mode_Schedule\", null, \"Switch\"],\n            [\"Operating_Mode_State\", null, \"Selector Switch\"], //7 levels - (0=Heat only, 10=Cool only, 20=Auto, 30=DHW only, 40=Heat+DHW, 50=Cool+DHW, 60=Auto+DHW)\n            [\"Main_Inlet_Temp\", 1605],\n            [\"Main_Outlet_Temp\", 1606], \n            [\"Main_Target_Temp\", null],\n            [\"Compressor_Freq\", 1608],\n            [\"DHW_Target_Temp\", null],\n            [\"DHW_Temp\", null],\n            [\"Operations_Hours\", 1611],\n            [\"Operations_Counter\", 1612],\n            [\"Main_Schedule_State\", null, \"Switch\"],\n            [\"Outside_Temp\", 1610],\n            [\"Heat_Energy_Production\", null],\n            [\"Heat_Energy_Consumption\", null],\n            [\"Powerful_Mode_Time\", null, \"Selector Switch\"], //  4 levels -- 0= off - 10= 30 Minute - 20= 60 Minute - 30= 90 Minute //0= off, 30 = level 3\n            [\"Quiet_Mode_Level\", 1704, \"Selector Switch\"], // 4 levels -- 0= off - 10= Silent 1 - 20= Silent 2 - 30= Silent 3\n            [\"Holiday_Mode_State\", null, \"Switch\"],\n            [\"ThreeWay_Valve_State\", null, \"Selector Switch\"], // 2 levels -- 0=Room, 10=DHW\n            [\"Outside_Pipe_Temp\", null],\n            [\"DHW_Heat_Delta\", null],\n            [\"Heat_Delta\", null],\n            [\"Cool_Delta\", null],\n            [\"DHW_Holiday_Shift_Temp\", null],\n            [\"Defrosting_State\", null, \"Switch\"],\n            [\"Z1_Heat_Request_Temp\", 1702, \"Thermostat\"],\n            [\"Z1_Cool_Request_Temp\", null],\n            [\"Z1_Heat_Curve_Target_High_Temp\", null],\n            [\"Z1_Heat_Curve_Target_Low_Temp\", null],\n            [\"Z1_Heat_Curve_Outside_High_Temp\", null],\n            [\"Z1_Heat_Curve_Outside_Low_Temp\", null],\n            [\"Room_Thermostat_Temp\", null],\n            [\"Z2_Heat_Request_Temp\", null],\n            [\"Z2_Cool_Request_Temp\", null],\n            [\"Z1_Water_Temp\", null],\n            [\"Z2_Water_Temp\", null],\n            [\"Cool_Energy_Production\", null],\n            [\"Cool_Energy_Consumption\", null],\n            [\"DHW_Energy_Production\", null],\n            [\"DHW_Energy_Consumption\", null],\n            [\"Z1_Water_Target_Temp\", null],\n            [\"Z2_Water_Target_Temp\", null],\n            [\"Error\", null],\n            [\"Room_Holiday_Shift_Temp\", null],\n            [\"Buffer_Temp\", null],\n            [\"Solar_Temp\", null],\n            [\"Pool_Temp\", null],\n            [\"Main_Hex_Outlet_Temp\", null],\n            [\"Discharge_Temp\", null],\n            [\"Inside_Pipe_Temp\", null],\n            [\"Defrost_Temp\", null],\n            [\"Eva_Outlet_Temp\", null],\n            [\"Bypass_Outlet_Temp\", null],\n            [\"Ipm_Temp\", null],\n            [\"Z1_Temp\", 1702],\n            [\"Z2_Temp\", null],\n            [\"DHW_Heater_State\", null],\n            [\"Room_Heater_State\", null],\n            [\"Internal_Heater_State\", 3095],\n            [\"External_Heater_State\", null],\n            [\"Fan1_Motor_Speed\", null],\n            [\"Fan2_Motor_Speed\", null],\n            [\"High_Pressure\", null],\n            [\"Pump_Speed\", null],\n            [\"Low_Pressure\", null],\n            [\"Compressor_Current\", null],\n            [\"Force_Heater_State\", null, \"Switch\"],\n            [\"Sterilization_State\", null, \"Switch\"],\n            [\"Sterilization_Temp\", null],\n            [\"Sterilization_Max_Time\", null],\n            [\"Z1_Cool_Curve_Target_High_Temp\", null],\n            [\"Z1_Cool_Curve_Target_Low_Temp\", null],\n            [\"Z1_Cool_Curve_Outside_High_Temp\", null],\n            [\"Z1_Cool_Curve_Outside_Low_Temp\", null],\n            [\"Heating_Mode\", null],\n            [\"Heating_Off_Outdoor_Temp\", null],\n            [\"Heater_On_Outdoor_Temp\", null],\n            [\"Heat_To_Cool_Temp\", null],\n            [\"Cool_To_Heat_Temp\", null],\n            [\"Cooling_Mode\", null],\n            [\"Heat_To_Cool_Temp\", null],\n            [\"Z2_Heat_Curve_Target_High_Temp\", null],\n            [\"Z2_Heat_Curve_Target_Low_Temp\", null],\n            [\"Z2_Heat_Curve_Outside_High_Temp\", null],\n            [\"Z2_Heat_Curve_Outside_Low_Temp\", null],\n            [\"Z2_Cool_Curve_Target_High_Temp\", null],\n            [\"Z2_Cool_Curve_Target_Low_Temp\", null],\n            [\"Z2_Cool_Curve_Outside_High_Temp\", null],\n            [\"Z2_Cool_Curve_Outside_Low_Temp\", null],\n            [\"Room_Heater_Operations_Hours\", null],\n            [\"DHW_Heater_Operations_Hours\", null]\n    ];\n    \ncontext.global.heishamon.ActionMapping = [\n    // actioncommand, type, \"IDx in Domoticz/Name in Home Assistant/ ?? openHAB ??\" \n    [\"SetHeatpump\", \"Switch\", 1703],\n    [\"SetHoliday\", \"Switch\", null],\n    [\"SetQuietMode\", \"Selector Switch\", 1704],\n    [\"SetPowerfull\", \"Selector Switch\", null],\n    [\"SetZ1HeatRequestTemperature\", \"Thermostat\", 1702],\n    [\"SetZ1CoolRequestTemperature\", \"Thermostat\", null],\n    [\"SetZ2HeatRequestTemperature\", \"Thermostat\", null],\n    [\"SetZ2CoolRequestTemperature\", \"Thermostat\", null],\n    [\"SetOperationMode\", \"Selector Switch\", null],\n    [\"SetForceDHW\", \"Switch\", null],\n    [\"SetDHWTemp\", \"Thermostat\", null],\n    [\"SetCoolTemp\", \"Thermostat\", null],\n    [\"SetForceDefrost\", \"Switch\", null],\n    [\"SetForceSterilization\", \"Switch\", null]\n];\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":120,"wires":[[]]},{"id":"b9850ca2.e3d7a8","type":"inject","z":"6f1bd5f9.4cdd9c","name":"","topic":"Startup","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":210,"y":120,"wires":[["5a304122.7f39e8"]]},{"id":"c33d4c1c.9461f8","type":"switch","z":"6f1bd5f9.4cdd9c","name":"Which HA app ","property":"heishamon.HAapplication","propertyType":"global","rules":[{"t":"cont","v":"Domoticz","vt":"str"},{"t":"cont","v":"HomeAssistant","vt":"str"},{"t":"cont","v":"openHAB","vt":"str"},{"t":"cont","v":"InfluxDB","vt":"str"}],"checkall":"true","repair":true,"outputs":4,"x":770,"y":300,"wires":[["5cc1b5a7.565794"],["b3adbd5e.d2c188"],["ca68e5fb.797e48"],["24450c97.1a66cc"]]},{"id":"5cc1b5a7.565794","type":"function","z":"6f1bd5f9.4cdd9c","name":"Prepare Domoticz output","func":"if(msg.HAid !== null){\n    msg1 = {};\n    msg1.payload = {};\n    msg1.payload.idx = msg.HAid; \n    msg1.topic = \"domoticz/in\";\n\n    if(msg.type == \"Selector Switch\"){\n        msg1.payload.command = \"switchlight\";\n        msg1.payload.switchcmd = \"Set Level\";\n        msg1.payload.level = msg.payload * 10;\n    }else if(msg.type == \"Switch\"){\n        msg1.payload.command = \"switchlight\"\n        if(msg.payload == 1){ cmd = \"On\"; }else{ cmd=\"Off\"}\n        msg1.payload.switchcmd = cmd;\n    }else{\n        msg1.payload.svalue = msg.payload;\n    }\n    return msg1;\n}\n\nreturn;","outputs":1,"noerr":0,"x":1050,"y":260,"wires":[["864dcbb4.29bdb","d93fa1dd.ba9b4"]]},{"id":"864dcbb4.29bdb","type":"mqtt out","z":"6f1bd5f9.4cdd9c","name":"MQTT publish","topic":"","qos":"","retain":"","broker":"2298f8af.6176e8","x":1360,"y":320,"wires":[]},{"id":"57ddcffb.7f6d28","type":"influxdb out","z":"6f1bd5f9.4cdd9c","influxdb":"9cf5a8bb.798e08","name":"","measurement":"heishamon","precision":"","retentionPolicy":"","x":1340,"y":540,"wires":[]},{"id":"24450c97.1a66cc","type":"function","z":"6f1bd5f9.4cdd9c","name":"Prepare InfluxDB output","func":"if(isNaN(parseFloat(msg.payload))){\n    return;\n}else{\n    \n    msg.payload = [{\n        numValue: parseFloat(msg.payload),\n        strValue: msg.sensor\n    },\n    {\n        tag1:msg.sensor\n    }];\n    return msg;\n}","outputs":1,"noerr":0,"x":1040,"y":540,"wires":[["57ddcffb.7f6d28"]]},{"id":"ca68e5fb.797e48","type":"function","z":"6f1bd5f9.4cdd9c","name":"Prepare openHAB output","func":"if(msg.payload.HAid != null){\n    //do something\n}\n\nreturn;","outputs":1,"noerr":0,"x":1050,"y":420,"wires":[["864dcbb4.29bdb"]]},{"id":"b3adbd5e.d2c188","type":"function","z":"6f1bd5f9.4cdd9c","name":"Prepare HomeAssistant output","func":"msg1 = {};\nmsg1.payload = msg.payload;\nmsg1.topic = \"home/\" + msg.HAid; // Example: home/Compressor_Freq (or how it is mentioned in global setup)\nreturn msg1;\n","outputs":1,"noerr":0,"x":1070,"y":340,"wires":[["864dcbb4.29bdb","d93fa1dd.ba9b4"]]},{"id":"e30e04b9.eabb68","type":"mqtt in","z":"6f1bd5f9.4cdd9c","name":"Domoticz Publish","topic":"domoticz/out/#","qos":"2","datatype":"auto","broker":"2298f8af.6176e8","x":180,"y":660,"wires":[["13d65aa6.c4e4ed"]]},{"id":"998636d3.ac6fc","type":"debug","z":"6f1bd5f9.4cdd9c","name":"","active":false,"console":"false","complete":"false","x":1030,"y":620,"wires":[]},{"id":"13d65aa6.c4e4ed","type":"json","z":"6f1bd5f9.4cdd9c","name":"","property":"payload","action":"","pretty":false,"x":390,"y":660,"wires":[["e4bd0e33.41649"]]},{"id":"e4bd0e33.41649","type":"function","z":"6f1bd5f9.4cdd9c","name":"Translate HomeAutomation to Heishamon","func":"//node.warn(msg.payload.idx)\nvar type;\n\nfor (i = 0; i < context.global.heishamon.ActionMapping.length; i++) {\n    if(msg.payload.idx == context.global.heishamon.ActionMapping[i][2]){\n        if(context.global.heishamon.ActionMapping[i][1]){\n            msg.topic = \"panasonic_heat_pump/\" + context.global.heishamon.ActionMapping[i][0];\n            type = context.global.heishamon.ActionMapping[i][1];\n            //node.warn(msg.payload);\n            switch(type){\n                case \"Selector Switch\":\n                    msg.payload = (msg.payload.svalue1 / 10);\n                    return msg;\n                case \"Thermostat\":\n                    msg.payload = parseInt(msg.payload.svalue1);\n                    return msg;\n                case \"Switch\":\n                    msg.payload = msg.payload.nvalue;\n                    return msg;\n            }\n\n        }\n    }\n}\n\nreturn;","outputs":1,"noerr":0,"x":660,"y":660,"wires":[["998636d3.ac6fc","c31e2c02.54f13"]]},{"id":"c31e2c02.54f13","type":"mqtt out","z":"6f1bd5f9.4cdd9c","name":"MQTT Publish Set-command","topic":"","qos":"","retain":"","broker":"2298f8af.6176e8","x":1320,"y":720,"wires":[]},{"id":"d93fa1dd.ba9b4","type":"debug","z":"6f1bd5f9.4cdd9c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1340,"y":420,"wires":[]},{"id":"16393f9b.83d35","type":"comment","z":"6f1bd5f9.4cdd9c","name":"Version 02","info":"Only the 'global setup' node needs to be changed (and if you're not running on localhost you need to change those mqtt connection nodes also). ","x":160,"y":60,"wires":[]},{"id":"2298f8af.6176e8","type":"mqtt-broker","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":15,"cleansession":true,"birthQos":"0","willQos":"0"},{"id":"9cf5a8bb.798e08","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"Panasonic","name":"Panasonic","usetls":false,"tls":""}]
